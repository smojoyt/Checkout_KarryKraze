<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Karry Kraze</title>
    <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.css" />
    <script async src="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
        }

        #loading {
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="loading">Loading your cart...</div>

    <div hidden id="snipcart" data-api-key="OTkwZGJhM2QtNmQyMy00ZGYxLTg4YzAtNmExNDA2MDhmNmU0NjM4NzgwMjMxMTgyOTYyMjAz"></div>

    <script>
    let productCatalog = {};

    // Fetch your products
    fetch("https://www.karrykraze.com/products/products.json")
      .then(res => res.json())
      .then(data => {
        productCatalog = data;
        waitForSnipcart();
      });

    function waitForSnipcart() {
      if (typeof Snipcart !== 'undefined' && Snipcart.api && Snipcart.api.theme) {
        runCheckout();
      } else {
        setTimeout(waitForSnipcart, 300);
      }
    }

    function runCheckout() {
      if (sessionStorage.getItem("itemsAdded") === "true") {
        hideLoading();
        return;
      }

      const params = new URLSearchParams(window.location.search);
      const skus = params.get("autocart");

      if (skus) {
        const skuArray = skus.split(",");
        skuArray.forEach((skuVariant, i) => {
          setTimeout(() => addItemToCart(skuVariant), i * 200);
        });

        setTimeout(() => {
          Snipcart.api.theme.cart.open();
          hideLoading();
          sessionStorage.setItem("itemsAdded", "true");
        }, skuArray.length * 200 + 500);
      } else {
        hideLoading();
      }
    }

    function addItemToCart(skuVariant) {
      const [sku, variant] = skuVariant.split(":");
      const p = productCatalog[sku];

      if (!p) {
        console.error("‚ùå Product not found for SKU:", sku);
        return;
      }

      const itemData = {
        id: sku,
        name: p.name,
        url: p.url.startsWith("http") ? p.url : window.location.origin + p.url,
        image: p.image,
        description: Array.isArray(p.descriptionList) ? p.descriptionList.join(", ") : p.description,
        price: p.price,
        quantity: 1
      };

      if (variant && p.custom1Name && p.custom1Options) {
        itemData.custom1Name = p.custom1Name;
        itemData.custom1Value = variant;
      }

      Snipcart.api.cart.items.add(itemData);
    }

    function hideLoading() {
      const loading = document.getElementById("loading");
      if (loading) loading.style.display = "none";
    }
    </script>

</body>
</html>
