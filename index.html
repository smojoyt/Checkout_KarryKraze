<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Karry Kraze</title>

    <!-- Snipcart CSS -->
    <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.css" />

    <!-- Snipcart Script -->
    <script async src="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        #button-container {
            display: none;
        }
    </style>
</head>
<body>

    <!-- Loading overlay -->
    <div id="loading-overlay">Loading your cart...</div>

    <!-- Hidden button container -->
    <div id="button-container"></div>

    <!-- Snipcart configuration -->
    <div hidden id="snipcart" data-api-key="OTkwZGJhM2QtNmQyMy00ZGYxLTg4YzAtNmExNDA2MDhmNmU0NjM4NzgwMjMxMTgyOTYyMjAz"></div>

    <script>
    let productCatalog = {};

    fetch("https://www.karrykraze.com/products/products.json")
      .then(res => res.json())
      .then(data => {
        productCatalog = data;
        waitForSnipcart();
      });

    function waitForSnipcart() {
      if (typeof Snipcart !== 'undefined' && Snipcart.api && Snipcart.api.theme) {
        runCheckoutLogic();
      } else {
        setTimeout(waitForSnipcart, 300);
      }
    }

    function runCheckoutLogic() {
      if (sessionStorage.getItem("itemsAdded") === "true") return;

      const params = new URLSearchParams(window.location.search);
      const skus = params.get("autocart");
      if (skus) {
        const skuArray = skus.split(",");

        skuArray.forEach((skuVariant, i) => {
          setTimeout(() => {
            createAndClickSnipcartButton(skuVariant.trim());
          }, i * 300);
        });

        setTimeout(() => {
          Snipcart.api.theme.cart.open();
          hideLoadingOverlay();
          sessionStorage.setItem("itemsAdded", "true");
        }, skuArray.length * 300 + 500);
      }
    }

    function createAndClickSnipcartButton(skuVariant) {
      const [sku, variant] = skuVariant.split(":");
      const p = productCatalog[sku];

      if (!p) {
        console.error(`Product not found for SKU: ${sku}`);
        return;
      }

      const btn = document.createElement("button");
      btn.className = "snipcart-add-item";
      btn.dataset.itemId = sku;
      btn.dataset.itemName = p.name;
      btn.dataset.itemUrl = p.url.startsWith('http') ? p.url : window.location.origin + p.url;
      btn.dataset.itemImage = p.image;
      btn.dataset.itemPrice = p.price;
      btn.dataset.itemQuantity = 1;

      if (Array.isArray(p.descriptionList)) {
        btn.dataset.itemDescription = p.descriptionList.join(", ");
      } else if (p.description) {
        btn.dataset.itemDescription = p.description;
      } else {
        btn.dataset.itemDescription = "No description available.";
      }

      if (p.custom1Name && p.custom1Options) {
        btn.dataset.itemCustom1Name = p.custom1Name;
        btn.dataset.itemCustom1Options = p.custom1Options;
        if (variant) {
          btn.dataset.itemCustom1Value = variant;
        }
      }

      document.getElementById("button-container").appendChild(btn);

      setTimeout(() => {
        btn.click();
      }, 100);
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.style.display = 'none';
    }

    </script>

</body>
</html>
